name: MANUAL ci-cd gridways backend

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '–í–µ—Ç–∫–∞ –¥–ª—è –¥–µ–ø–ª–æ—è'
        required: true
        type: choice
        options:
          - testing
          - main
        default: 'testing'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}


jobs:
  # ==========================================
  # üñêÔ∏è –†–£–ß–ù–û–ô –§–õ–û–£ (—Ç–æ–ª—å–∫–æ –¥–ª—è workflow_dispatch)
  # ==========================================
  manual-build-and-deploy:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    environment: ${{ github.event.inputs.branch == 'main' && 'production' || 'testing' }}
    env:
      MODE: ${{ github.event.inputs.branch == 'main' && 'production' || 'testing' }}

    steps:
      - name: üì• –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: üîê –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üîê –°–æ–∑–¥–∞–µ–º .env –∏–∑ Environment secrets
        run: |
          cat > .env << EOF
          APP_PORT_OUTSIDE=${{ secrets.APP_PORT_OUTSIDE }}
          
          DB_PORT_OUTSIDE=${{ secrets.DB_PORT_OUTSIDE }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_HOST=${{ secrets.DB_HOST }} 
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          
          KAFKA_BOOTSTRAP_SERVERS=${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
          
          ELASTIC_USERNAME=${{ secrets.ELASTIC_USERNAME }}
          ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }}
          KIBANA_SYSTEM_PASSWORD=${{ secrets.KIBANA_SYSTEM_PASSWORD }}
          APM_SECRET_TOKEN=${{ secrets.APM_SECRET_TOKEN }}
          
          EOF
          
          echo "‚úÖ .env —Å–æ–∑–¥–∞–Ω –¥–ª—è Environment: ${{ env.MODE }}"

      - name: üî® –ë–∏–ª–¥–∏–º —Å–≤–æ–∏ —Å–µ—Ä–≤–∏—Å—ã
        run: |
          export TAG="${{ env.MODE }}"
          
          # –°–µ—Ä–≤–∏—Å—ã —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å build: –≤ docker-compose
          OUR_SERVICES="migrant api rest events cron"
          
          echo "üöÄ –ë–∏–ª–¥–∏–º: $OUR_SERVICES"
          echo "üè∑Ô∏è –¢–µ–≥: $TAG"
          echo ""
          
          docker compose build $OUR_SERVICES

      - name: üì§ –ü—É—à–∏–º –æ–±—Ä–∞–∑—ã –≤ registry
        run: |
          export TAG="${{ env.MODE }}"
          
          OUR_SERVICES="migrant api rest events cron"
          
          echo "üì§ –ü—É—à–∏–º –æ–±—Ä–∞–∑—ã..."
          docker compose push $OUR_SERVICES
          
          echo "‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã –≤ registry!"

      - name: Send docker-compose
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_SERVER }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "docker-compose.yaml,nginx/nginx.conf"
          target: "/srv/cardgame/backend/${{ env.MODE }}"

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1
        env:
          TAG: ${{ env.MODE }}
          MODE: ${{ env.MODE }}
          BACKEND_IMAGE_NAME: ${{ github.repository }}
          ENV_CONTENT: |
            CONFIG=${{ secrets.CONFIG }}
            
            APP_PORT_OUTSIDE=${{ secrets.APP_PORT_OUTSIDE }}
            
            DB_PORT_OUTSIDE=${{ secrets.DB_PORT_OUTSIDE }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_HOST=${{ secrets.DB_HOST }} 
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
            DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
            DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
            
            USER_PASSWORD_SECRET_KEY=${{ secrets.USER_PASSWORD_SECRET_KEY }}
            
            KAFKA_BOOTSTRAP_SERVERS=${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
            
            ELASTIC_USERNAME=${{ secrets.ELASTIC_USERNAME }}
            ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }}
            KIBANA_SYSTEM_PASSWORD=${{ secrets.KIBANA_SYSTEM_PASSWORD }}
            APM_SECRET_TOKEN=${{ secrets.APM_SECRET_TOKEN }}

        with:
          host: ${{ secrets.SSH_SERVER }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: ENV_CONTENT,MODE,TAG,BACKEND_IMAGE_NAME
          script: |
            export TAG="$TAG"
            export MODE="$MODE"
            export BACKEND_IMAGE_NAME="$BACKEND_IMAGE_NAME"

            cd /srv/cardgame/backend/$MODE
            
            printf '%s\n' "$ENV_CONTENT" > .env.docker
            
            echo "üì• –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "üì• –ü—É–ª–ª–∏–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker-compose pull migrant api rest events cron
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            docker-compose --env-file .env.docker up -d
            
            echo "üßπ –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker image prune -f
            
            echo ""
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
            docker-compose ps

      - name: üìã –ò—Ç–æ–≥
        run: |
          echo "=========================================="
          echo "‚úÖ –†—É—á–Ω–æ–π –±–∏–ª–¥ –∏ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
          echo "=========================================="
