name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, testing ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}


jobs:
  validate-if-pr-to-main-from-testing-only:
    runs-on: ubuntu-latest
    outputs:
      pr_valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Check PR to main is from testing only
        id: validate
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ Pull Request..."
          echo "–¶–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞: ${{ github.base_ref }}"
          echo "–ò—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ç–∫–∞: ${{ github.head_ref }}"
          
          if [[ "${{ github.base_ref }}" == "main" && "${{ github.head_ref }}" != "testing" ]]; then
            echo "‚ùå PR to main can only be from testing branch"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Valid PR: main ‚Üê testing"
          echo "valid=true" >> $GITHUB_OUTPUT

  linters-and-tests:
    needs: validate-if-pr-to-main-from-testing-only
    if: needs.validate-if-pr-to-main-from-testing-only.outputs.pr_valid == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r lib/requirements-dev.txt
        pip install -r services/api/requirements.txt
        pip install -r services/cron/requirements.txt
        pip install -r services/events/requirements.txt
        pip install -r services/migrant/requirements.txt
        pip install -r services/rest/requirements.txt

    - name: Create test environment file
      run: |
        cat > .env << EOF
        CONFIG=test_local
        TEST_DB_PASSWORD=postgres_password
        EOF
        echo "‚úÖ Created .env file"

    - name: Run ruff check
      run: |
        echo "üîç Checking code with ruff..."

        echo "üìã Running ruff check..."
        ruff check .
        if [ $? -ne 0 ]; then
          echo "‚ùå Linting issues found!"
          echo "Please run 'ruff check --fix .' locally and commit the changes"
          exit 1
        fi
        echo "‚úÖ Linting passed"

        echo "üìã Running ruff format check..."
        ruff format --check .
        if [ $? -ne 0 ]; then
          echo "‚ùå Code formatting issues found!"
          echo "Please run 'ruff format .' locally and commit the changes"
          exit 1
        fi
        echo "‚úÖ Code formatting is correct"

        echo "üéâ All checks passed!"

    - name: Run tests
      run: |
        pytest -s -vv

  analyze-changes:
    needs: linters-and-tests
    runs-on: ubuntu-latest
    outputs:
      services_to_build: ${{ steps.detect.outputs.services }}
      build_all: ${{ steps.detect.outputs.build_all }}
      services_json: ${{ steps.detect.outputs.services_json }}

    steps:
      - name: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        id: detect
        run: |
          echo "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ PR..."
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          echo "üìÑ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          echo "$CHANGED_FILES"
          echo ""
          
          # –ü–†–ê–í–ò–õ–û 1: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã
          ONLY_TESTS=true
          for file in $CHANGED_FILES; do
            if [[ ! $file =~ /tests/ ]] && [[ ! $file =~ ^lib/tests/ ]]; then
              ONLY_TESTS=false
            fi
          done
          
          if [[ "$ONLY_TESTS" == "true" ]]; then
            echo "üìù –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –∏–∑–º–µ–Ω–µ–Ω—ã - –Ω–∏—á–µ–≥–æ –Ω–µ –±–∏–ª–¥–∏–º"
            echo "services=" >> $GITHUB_OUTPUT
            echo "build_all=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ü–†–ê–í–ò–õ–û 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º CI/CD —Ñ–∞–π–ª—ã
          CI_FILES_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ ^\.github/ ]] || [[ $file =~ (docker-compose|Dockerfile) ]]; then
              CI_FILES_CHANGED=true
            fi
          done
          
          if [[ "$CI_FILES_CHANGED" == "true" ]]; then
            echo "‚öôÔ∏è  –ò–∑–º–µ–Ω–µ–Ω—ã CI/CD —Ñ–∞–π–ª—ã - –±–∏–ª–¥–∏–º –í–°–ï —Å–µ—Ä–≤–∏—Å—ã"
            echo "build_all=true" >> $GITHUB_OUTPUT
            echo "services=migrant,api,rest,events,cron" >> $GITHUB_OUTPUT
            SERVICES_JSON="[\"$(echo "$CHANGED_SERVICES" | sed 's/,/","/g')\"]"
            echo "‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ JSON: $SERVICES_JSON"
            echo "services_json=$SERVICES_JSON" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ü–†–ê–í–ò–õ–û 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º lib/utils (–∫—Ä–æ–º–µ models)
          LIB_UTILS_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ ^lib/utils/ ]] && [[ ! $file =~ ^lib/utils/models/ ]]; then
              LIB_UTILS_CHANGED=true
            fi
          done
          
          if [[ "$LIB_UTILS_CHANGED" == "true" ]]; then
            echo "üìö –ò–∑–º–µ–Ω–µ–Ω—ã –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã - –±–∏–ª–¥–∏–º –í–°–ï —Å–µ—Ä–≤–∏—Å—ã"
            echo "build_all=true" >> $GITHUB_OUTPUT
            echo "services=migrant,api,rest,events,cron" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ü–†–ê–í–ò–õ–û 4: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
          echo "üîé –ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã..."
          CHANGED_SERVICES=""
          
          # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          ALL_SERVICES=("migrant" "api" "rest" "events" "cron")
          
          for service in "${ALL_SERVICES[@]}"; do
            for file in $CHANGED_FILES; do
              if [[ $file =~ ^services/$service/ ]] && [[ ! $file =~ ^services/$service/tests/ ]]; then
                echo "‚úÖ –°–µ—Ä–≤–∏—Å '$service' –∏–∑–º–µ–Ω–∏–ª—Å—è"
                CHANGED_SERVICES="$CHANGED_SERVICES$service,"
                break
              fi
            done
          done
          
          # –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø—è—Ç—É—é
          CHANGED_SERVICES=${CHANGED_SERVICES%,}
          
          # –ü–†–ê–í–ò–õ–û 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx.conf
          NGINX_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ nginx\.conf$ ]]; then
              NGINX_CHANGED=true
              echo "üåê –ò–∑–º–µ–Ω–µ–Ω nginx.conf"
              break
            fi
          done
          
          # –î–æ–±–∞–≤–ª—è–µ–º nginx –≤ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
          if [[ "$NGINX_CHANGED" == "true" ]]; then
            echo "‚ûï –î–æ–±–∞–≤–ª—è–µ–º nginx –≤ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Å–±–æ—Ä–∫–∏"
            if [[ -n "$CHANGED_SERVICES" ]]; then
              CHANGED_SERVICES="$CHANGED_SERVICES,nginx"
            else
              CHANGED_SERVICES="nginx"
            fi
          fi
          
          echo "üì¶ –°–µ—Ä–≤–∏—Å—ã –¥–ª—è —Å–±–æ—Ä–∫–∏: $CHANGED_SERVICES"
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "build_all=false" >> $GITHUB_OUTPUT
          
          if [[ -n "$CHANGED_SERVICES" ]]; then
            # –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ sed –∏ tr (–ø—Ä–æ—Å—Ç–æ–π)
            SERVICES_JSON="[\"$(echo "$CHANGED_SERVICES" | sed 's/,/","/g')\"]"
            echo "‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ JSON: $SERVICES_JSON"
            echo "services_json=$SERVICES_JSON" >> $GITHUB_OUTPUT
          else
            echo "services_json=[]" >> $GITHUB_OUTPUT
          fi

  build-images:
    needs: [ linters-and-tests, analyze-changes]
    if: |
      needs.analyze-changes.outputs.services_to_build != '' &&
      success()

    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.analyze-changes.outputs.services_json) }}

    steps:
      - name: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: –ë–∏–ª–¥ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞
        run: |
          echo "üî® –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ –¥–ª—è ${{ matrix.service }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–≥
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            TAG="production"
          else
            TAG="testing"
          fi
          
          echo "${{ matrix.service }}:$TAG"
