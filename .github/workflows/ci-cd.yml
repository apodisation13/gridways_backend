name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, testing ]
    types: [opened, synchronize, closed]

  workflow_dispatch:
    inputs:
      environment:
        description: '–¶–µ–ª–µ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ'
        required: true
        default: 'testing'
        type: choice
        options:
          - testing
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}


jobs:
  validate-if-pr-to-main-from-testing-only:
    runs-on: ubuntu-latest
    outputs:
      pr_valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Check PR to main is from testing only
        id: validate
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ Pull Request..."
          echo "–¶–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞: ${{ github.base_ref }}"
          echo "–ò—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ç–∫–∞: ${{ github.head_ref }}"
          
          if [[ "${{ github.base_ref }}" == "main" && "${{ github.head_ref }}" != "testing" ]]; then
            echo "‚ùå PR to main can only be from testing branch"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Valid PR: main ‚Üê testing"
          echo "valid=true" >> $GITHUB_OUTPUT

  linters-and-tests:
    needs: validate-if-pr-to-main-from-testing-only
    if: needs.validate-if-pr-to-main-from-testing-only.outputs.pr_valid == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r lib/requirements-dev.txt
        pip install -r services/api/requirements.txt
        pip install -r services/cron/requirements.txt
        pip install -r services/events/requirements.txt
        pip install -r services/migrant/requirements.txt
        pip install -r services/rest/requirements.txt

    - name: Create test environment file
      run: |
        cat > .env << EOF
        CONFIG=test_local
        TEST_DB_PASSWORD=postgres_password
        EOF
        echo "‚úÖ Created .env file"

    - name: Run ruff check
      run: |
        echo "üîç Checking code with ruff..."

        echo "üìã Running ruff check..."
        ruff check .
        if [ $? -ne 0 ]; then
          echo "‚ùå Linting issues found!"
          echo "Please run 'ruff check --fix .' locally and commit the changes"
          exit 1
        fi
        echo "‚úÖ Linting passed"

        echo "üìã Running ruff format check..."
        ruff format --check .
        if [ $? -ne 0 ]; then
          echo "‚ùå Code formatting issues found!"
          echo "Please run 'ruff format .' locally and commit the changes"
          exit 1
        fi
        echo "‚úÖ Code formatting is correct"

        echo "üéâ All checks passed!"

    - name: Run tests
      run: |
        pytest -s -vv

  analyze-changes:
    if: github.event_name != 'workflow_dispatch'
    needs: linters-and-tests
    runs-on: ubuntu-latest
    outputs:
      services_to_build: ${{ steps.detect.outputs.services }}
      build_all: ${{ steps.detect.outputs.build_all }}
      services_json: ${{ steps.detect.outputs.services_json }}

    steps:
      - name: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        id: detect
        run: |
          ALL_SERVICES_LIST="migrant,api,rest,events,cron"
          
          echo "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ PR..."
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          echo "üìÑ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          echo "$CHANGED_FILES"
          echo ""
          
          # –ü–†–ê–í–ò–õ–û 1: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã
          ONLY_TESTS=true
          for file in $CHANGED_FILES; do
            if [[ ! $file =~ /tests/ ]] && [[ ! $file =~ ^lib/tests/ ]]; then
              ONLY_TESTS=false
            fi
          done
          
          if [[ "$ONLY_TESTS" == "true" ]]; then
            echo "üìù –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –∏–∑–º–µ–Ω–µ–Ω—ã - –Ω–∏—á–µ–≥–æ –Ω–µ –±–∏–ª–¥–∏–º"
            echo "services=" >> $GITHUB_OUTPUT
            echo "build_all=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ü–†–ê–í–ò–õ–û 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º lib/utils (–∫—Ä–æ–º–µ models)
          LIB_UTILS_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ ^lib/utils/ ]] && [[ ! $file =~ ^lib/utils/models/ ]]; then
              LIB_UTILS_CHANGED=true
            fi
          done
          
          if [[ "$LIB_UTILS_CHANGED" == "true" ]]; then
            echo "üìö –ò–∑–º–µ–Ω–µ–Ω—ã –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã - –±–∏–ª–¥–∏–º –í–°–ï —Å–µ—Ä–≤–∏—Å—ã"
            echo "build_all=true" >> $GITHUB_OUTPUT
            echo "services=migrant,api,rest,events,cron" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ü–†–ê–í–ò–õ–û 3: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
          echo "üîé –ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã..."
          CHANGED_SERVICES=""
          
          # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          ALL_SERVICES=("migrant" "api" "rest" "events" "cron")
          
          for service in "${ALL_SERVICES[@]}"; do
            for file in $CHANGED_FILES; do
              if [[ $file =~ ^services/$service/ ]] && [[ ! $file =~ ^services/$service/tests/ ]]; then
                echo "‚úÖ –°–µ—Ä–≤–∏—Å '$service' –∏–∑–º–µ–Ω–∏–ª—Å—è"
                CHANGED_SERVICES="$CHANGED_SERVICES$service,"
                break
              fi
            done
          done
          
          # –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø—è—Ç—É—é
          CHANGED_SERVICES=${CHANGED_SERVICES%,}
          
          echo "üì¶ –°–µ—Ä–≤–∏—Å—ã –¥–ª—è —Å–±–æ—Ä–∫–∏: $CHANGED_SERVICES"
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "build_all=false" >> $GITHUB_OUTPUT
          
          if [[ -n "$CHANGED_SERVICES" ]]; then
            # –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ sed –∏ tr (–ø—Ä–æ—Å—Ç–æ–π)
            SERVICES_JSON="[\"$(echo "$CHANGED_SERVICES" | sed 's/,/","/g')\"]"
            echo "‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ JSON: $SERVICES_JSON"
            echo "services_json=$SERVICES_JSON" >> $GITHUB_OUTPUT
          else
            echo "services_json=[]" >> $GITHUB_OUTPUT
          fi

  build-images:
    needs: [ linters-and-tests, analyze-changes ]
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      needs.analyze-changes.outputs.services_to_build != ''

    runs-on: ubuntu-latest

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Ç–∫–µ
    environment: ${{ github.base_ref == 'main' && 'production' || 'testing' }}

    strategy:
      matrix:
        service: ${{ fromJson(needs.analyze-changes.outputs.services_json) }}

    steps:
      - name: üì• –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: üè∑Ô∏è –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–≥
        id: vars
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "tag=production" >> $GITHUB_OUTPUT
            echo "üè∑Ô∏è –û–∫—Ä—É–∂–µ–Ω–∏–µ: production"
          else
            echo "tag=testing" >> $GITHUB_OUTPUT
            echo "üè∑Ô∏è –û–∫—Ä—É–∂–µ–Ω–∏–µ: testing"
          fi

      - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üî® –ë–∏–ª–¥ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞
        run: |
          export TAG="${{ steps.vars.outputs.tag }}"
          
          echo "üî® –°–æ–±–∏—Ä–∞–µ–º: ${{ matrix.service }}"
          echo "üè∑Ô∏è –¢–µ–≥: $TAG"
          
          docker-compose build ${{ matrix.service }}
          docker-compose push ${{ matrix.service }}
          
          echo "‚úÖ ${{ matrix.service }}:$TAG –≥–æ—Ç–æ–≤!"

  # ==========================================
  # üöÄ –î–ï–ü–õ–û–ô (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –±–∏–ª–¥–æ–≤)
  # ==========================================
  deploy:
    needs: [ analyze-changes, build-images ]
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      needs.analyze-changes.outputs.services_to_build != ''

    runs-on: ubuntu-latest

    environment: ${{ github.base_ref == 'main' && 'production' || 'testing' }}

    steps:
      - name: üè∑Ô∏è –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        id: vars
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "tag=production" >> $GITHUB_OUTPUT
          else
            echo "tag=testing" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ ${{ steps.vars.outputs.tag }}"
            
            cd ${{ secrets.PROJECT_PATH }}
            
            export TAG="${{ steps.vars.outputs.tag }}"
            
            # –õ–æ–≥–∏–Ω –≤ registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –ü—É–ª–ª–∏–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            echo "üì• –ü—É–ª–ª–∏–º: ${{ needs.analyze-changes.outputs.services_to_build }}"
            docker-compose pull ${{ needs.analyze-changes.outputs.services_to_build }}
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            docker-compose up -d
            
            # –ß–∏—Å—Ç–∏–º
            docker image prune -f
            
            echo ""
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
            docker-compose ps  
  

  # ==========================================
  # üñêÔ∏è –†–£–ß–ù–û–ô –§–õ–û–£ (—Ç–æ–ª—å–∫–æ –¥–ª—è workflow_dispatch)
  # ==========================================
  manual-build-and-deploy:
    if: github.event_name == 'workflow_dispatch'
    needs: linters-and-tests
    runs-on: ubuntu-latest

    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: üì• –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: üîê –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üî® –ë–∏–ª–¥–∏–º —Å–≤–æ–∏ —Å–µ—Ä–≤–∏—Å—ã
        run: |
          export TAG="${{ github.event.inputs.environment }}"
          
          # –°–µ—Ä–≤–∏—Å—ã —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å build: –≤ docker-compose
          OUR_SERVICES="migrant api rest events cron"
          
          echo "üöÄ –ë–∏–ª–¥–∏–º: $OUR_SERVICES"
          echo "üè∑Ô∏è –¢–µ–≥: $TAG"
          echo ""
          
          docker-compose build $OUR_SERVICES

      - name: üì§ –ü—É—à–∏–º –æ–±—Ä–∞–∑—ã –≤ registry
        run: |
          export TAG="${{ github.event.inputs.environment }}"
          
          OUR_SERVICES="migrant api rest events cron"
          
          echo "üì§ –ü—É—à–∏–º –æ–±—Ä–∞–∑—ã..."
          docker-compose push $OUR_SERVICES
          
          echo "‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã –≤ registry!"

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ ${{ github.event.inputs.environment }}"
            
            cd ${{ secrets.PROJECT_PATH }}
            
            export TAG="${{ github.event.inputs.environment }}"
            
            echo "üì• –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "üì• –ü—É–ª–ª–∏–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker-compose pull migrant api rest events cron
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            docker-compose up -d
            
            echo "üßπ –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker image prune -f
            
            echo ""
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
            docker-compose ps

      - name: üìã –ò—Ç–æ–≥
        run: |
          echo "=========================================="
          echo "‚úÖ –†—É—á–Ω–æ–π –±–∏–ª–¥ –∏ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
          echo "=========================================="
          echo ""
          echo "üè∑Ô∏è –û–∫—Ä—É–∂–µ–Ω–∏–µ: ${{ github.event.inputs.environment }}"
          echo "üì¶ –°–µ—Ä–≤–∏—Å—ã: migrant, api, rest, events, cron"
          echo "üñ•Ô∏è –°–µ—Ä–≤–µ—Ä: ${{ secrets.SERVER_HOST }}"
