name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, testing ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}


jobs:
  validate-if-pr-to-main-from-testing-only:
    runs-on: ubuntu-latest
    outputs:
      pr_valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Check PR to main is from testing only
        id: validate
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Pull Request..."
          echo "Ð¦ÐµÐ»ÐµÐ²Ð°Ñ Ð²ÐµÑ‚ÐºÐ°: ${{ github.base_ref }}"
          echo "Ð˜ÑÑ…Ð¾Ð´Ð½Ð°Ñ Ð²ÐµÑ‚ÐºÐ°: ${{ github.head_ref }}"
          
          if [[ "${{ github.base_ref }}" == "main" && "${{ github.head_ref }}" != "testing" ]]; then
            echo "âŒ PR to main can only be from testing branch"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Valid PR: main â† testing"
          echo "valid=true" >> $GITHUB_OUTPUT

  linters-and-tests:
    needs: validate-if-pr-to-main-from-testing-only
    if: needs.validate-if-pr-to-main-from-testing-only.outputs.pr_valid == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r lib/requirements-dev.txt
        pip install -r services/api/requirements.txt
        pip install -r services/cron/requirements.txt
        pip install -r services/events/requirements.txt
        pip install -r services/migrant/requirements.txt
        pip install -r services/rest/requirements.txt

    - name: Create test environment file
      run: |
        cat > .env << EOF
        CONFIG=test_local
        TEST_DB_PASSWORD=postgres_password
        EOF
        echo "âœ… Created .env file"

    - name: Run ruff check
      run: |
        echo "ðŸ” Checking code with ruff..."

        echo "ðŸ“‹ Running ruff check..."
        ruff check .
        if [ $? -ne 0 ]; then
          echo "âŒ Linting issues found!"
          echo "Please run 'ruff check --fix .' locally and commit the changes"
          exit 1
        fi
        echo "âœ… Linting passed"

        echo "ðŸ“‹ Running ruff format check..."
        ruff format --check .
        if [ $? -ne 0 ]; then
          echo "âŒ Code formatting issues found!"
          echo "Please run 'ruff format .' locally and commit the changes"
          exit 1
        fi
        echo "âœ… Code formatting is correct"

        echo "ðŸŽ‰ All checks passed!"

    - name: Run tests
      run: |
        pytest -s -vv

  analyze-changes:
    needs: linters-and-tests
    runs-on: ubuntu-latest
    outputs:
      services_to_build: ${{ steps.detect.outputs.services }}
      build_all: ${{ steps.detect.outputs.build_all }}

    steps:
      - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
        id: detect
        run: |
          echo "ðŸ” ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ Ð² PR..."
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          echo "ðŸ“„ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:"
          echo "$CHANGED_FILES"
          echo ""
          
          # ÐŸÐ ÐÐ’Ð˜Ð›Ðž 1: Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ ÐµÑÐ»Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÑÑ‚Ñ‹
          ONLY_TESTS=true
          for file in $CHANGED_FILES; do
            if [[ ! $file =~ /tests/ ]] && [[ ! $file =~ ^lib/tests/ ]]; then
              ONLY_TESTS=false
            fi
          done
          
          if [[ "$ONLY_TESTS" == "true" ]]; then
            echo "ðŸ“ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÑÑ‚Ñ‹ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ñ‹ - Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð±Ð¸Ð»Ð´Ð¸Ð¼"
            echo "services=" >> $GITHUB_OUTPUT
            echo "build_all=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ÐŸÐ ÐÐ’Ð˜Ð›Ðž 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ CI/CD Ñ„Ð°Ð¹Ð»Ñ‹
          CI_FILES_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ ^\.github/ ]] || [[ $file =~ (docker-compose|Dockerfile) ]]; then
              CI_FILES_CHANGED=true
            fi
          done
          
          if [[ "$CI_FILES_CHANGED" == "true" ]]; then
            echo "âš™ï¸  Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ñ‹ CI/CD Ñ„Ð°Ð¹Ð»Ñ‹ - Ð±Ð¸Ð»Ð´Ð¸Ð¼ Ð’Ð¡Ð• ÑÐµÑ€Ð²Ð¸ÑÑ‹"
            echo "build_all=true" >> $GITHUB_OUTPUT
            echo "services=migrant,api,rest,events,cron" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ÐŸÐ ÐÐ’Ð˜Ð›Ðž 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ lib/utils (ÐºÑ€Ð¾Ð¼Ðµ models)
          LIB_UTILS_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ ^lib/utils/ ]] && [[ ! $file =~ ^lib/utils/models/ ]]; then
              LIB_UTILS_CHANGED=true
            fi
          done
          
          if [[ "$LIB_UTILS_CHANGED" == "true" ]]; then
            echo "ðŸ“š Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð¾Ð±Ñ‰Ð¸Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ - Ð±Ð¸Ð»Ð´Ð¸Ð¼ Ð’Ð¡Ð• ÑÐµÑ€Ð²Ð¸ÑÑ‹"
            echo "build_all=true" >> $GITHUB_OUTPUT
            echo "services=migrant,api,rest,events,cron" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ÐŸÐ ÐÐ’Ð˜Ð›Ðž 4: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          echo "ðŸ”Ž Ð˜Ñ‰ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
          CHANGED_SERVICES=""
          
          # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
          ALL_SERVICES=("migrant" "api" "rest" "events" "cron")
          
          for service in "${ALL_SERVICES[@]}"; do
            for file in $CHANGED_FILES; do
              if [[ $file =~ ^services/$service/ ]] && [[ ! $file =~ ^services/$service/tests/ ]]; then
                echo "âœ… Ð¡ÐµÑ€Ð²Ð¸Ñ '$service' Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ"
                CHANGED_SERVICES="$CHANGED_SERVICES$service,"
                break
              fi
            done
          done
          
          # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ
          CHANGED_SERVICES=${CHANGED_SERVICES%,}
          
          # ÐŸÐ ÐÐ’Ð˜Ð›Ðž 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx.conf
          NGINX_CHANGED=false
          for file in $CHANGED_FILES; do
            if [[ $file =~ nginx\.conf$ ]]; then
              NGINX_CHANGED=true
              echo "ðŸŒ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½ nginx.conf"
              break
            fi
          done
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ nginx Ð² ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ
          if [[ "$NGINX_CHANGED" == "true" ]]; then
            echo "âž• Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ nginx Ð² ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸"
            if [[ -n "$CHANGED_SERVICES" ]]; then
              CHANGED_SERVICES="$CHANGED_SERVICES,nginx"
            else
              CHANGED_SERVICES="nginx"
            fi
          fi
          
          echo "ðŸ“¦ Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸: $CHANGED_SERVICES"
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "build_all=false" >> $GITHUB_OUTPUT
